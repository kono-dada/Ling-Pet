# 固定桌宠功能实现说明

## 功能概述

本次实现为桌宠应用添加了固定桌宠功能，允许用户通过右键菜单启用/禁用固定模式。在固定模式下：

- 左键点击桌宠时，窗口会暂时变为可透过，让鼠标事件穿透到下层窗口
- 右键点击桌宠时，窗口保持不可透过，正常显示右键菜单
- 右键菜单打开时会暂停hook并确保窗口不可透过

## 实现的文件和功能

### 前端部分 (TypeScript/Vue)

1. **`src/stores/configs/appearanceConfig.ts`**
   - 添加了 `isPetFixed` 配置项用于控制固定桌宠的启用状态

2. **`src/components/main/ContextMenu.vue`** 
   - 在右键菜单底部添加了"固定桌宠"/"取消固定"选项
   - 集成了固定桌宠管理器，在菜单显示/隐藏时通知管理器

3. **`src/pages/MainPage.vue`**
   - 添加了对固定桌宠状态的监听
   - 在组件初始化和销毁时管理固定桌宠功能
   - 在右键菜单事件中集成了固定桌宠逻辑

4. **`src/services/petFixManager.ts`** (新文件)
   - 核心功能管理器，负责：
     - 启动/停止鼠标hook监听
     - 处理鼠标事件并控制窗口透明度
     - 管理右键菜单状态
     - 轮询鼠标事件并处理桌宠区域判断

### 后端部分 (Rust)

1. **`src-tauri/Cargo.toml`**
   - 添加了Windows hook相关依赖：`winapi` 和 `once_cell`

2. **`src-tauri/src/mouse_hook.rs`** (新文件)
   - 实现了Windows平台的全局鼠标事件监听
   - 包含详细的调试信息输出
   - 线程安全的事件通信机制
   - 支持启动/停止/状态查询等操作

3. **`src-tauri/src/commands.rs`**
   - 添加了以下Tauri命令：
     - `start_mouse_hook`: 启动鼠标hook
     - `stop_mouse_hook`: 停止鼠标hook  
     - `get_mouse_hook_status`: 获取hook状态
     - `get_mouse_position`: 获取鼠标位置
     - `poll_mouse_events`: 轮询鼠标事件
     - `set_window_click_through`: 设置窗口点击穿透
     - `set_hook_target_window`: 设置hook目标窗口

4. **`src-tauri/src/lib.rs`**
   - 注册了新的Tauri命令
   - 添加了MouseHookState管理器

## 工作原理

1. **启用固定桌宠**：
   - 用户在右键菜单中点击"固定桌宠"
   - 前端更新 `isPetFixed` 状态
   - `MainPage.vue` 监听到状态变化，调用 `petFixManager.startPetFix()`
   - 固定桌宠管理器调用Rust命令启动全局鼠标hook
   - 开始轮询鼠标事件

2. **鼠标事件处理**：
   - Rust端的低级鼠标hook捕获全局鼠标事件
   - 事件通过channel发送到管理器
   - 前端通过轮询获取鼠标事件
   - 判断鼠标是否在桌宠窗口内
   - 根据鼠标按钮类型执行相应操作

3. **左键点击处理**：
   - 检测到左键点击桌宠时
   - 设置窗口为可透过模式
   - 50ms后自动恢复为不可透过

4. **右键点击处理**：
   - 检测到右键点击桌宠时  
   - 确保窗口不可透过
   - 显示右键菜单

5. **右键菜单管理**：
   - 菜单打开时暂停hook效果，确保窗口不可透过
   - 菜单关闭时恢复正常hook行为

## 调试功能

实现包含了详细的调试日志，在开发者控制台和Rust日志中都可以看到：

- Hook的启动/停止状态
- 鼠标事件的捕获和处理
- 窗口透明度的切换
- 鼠标位置和桌宠区域判断
- 错误信息和状态变化

## 兼容性

- **Windows**: 完整支持，使用WinAPI实现全局鼠标hook
- **macOS/Linux**: 提供存根实现，不会影响应用运行但功能不可用

## 注意事项

1. 此功能需要Windows平台支持
2. 需要适当的系统权限来设置全局鼠标hook
3. Hook的启动/停止会影响系统性能，因此提供了完整的生命周期管理
4. 右键菜单打开时会自动暂停hook以确保用户交互不受影响

## 使用方法

1. 启动桌宠应用
2. 右键点击桌宠
3. 在菜单底部选择"固定桌宠" 
4. 现在左键点击桌宠会让鼠标事件穿透到下层窗口
5. 右键点击桌宠仍可正常打开菜单
6. 再次选择"取消固定"可禁用此功能